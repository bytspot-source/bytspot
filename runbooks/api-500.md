# Runbook: API returning HTTP 500s

## Symptoms
- Alerts: 5xx ratio > 1% (5m), p95 latency > 300ms, user reports
- Logs show stack traces or DB timeouts

## Immediate actions
1) Confirm scope
- Check error rate and latency dashboards (last 30m)
- Verify impacted endpoints and regions

2) Recent changes
- `gcloud run revisions list --service=bytspot-api`
- If deploy in last 30m, consider rollback

3) Rollback (safe mitigation)
- `gcloud run services update-traffic bytspot-api --to-revisions REVISION=100`
- Or pin to previous: `gcloud run services update-traffic bytspot-api --to-revisions PREV=100`

4) Resource pressure
- Inspect Cloud Run metrics: CPU/mem/concurrency throttling
- Temporarily increase `max-instances` or lower `concurrency`

5) Downstream dependencies
- Cloud SQL: connections, errors, CPU, storage, locks
- Secret Manager: permission errors; expired/rotated keys
- Firestore/Redis: latency spikes, quota

6) Hotfix path
- Toggle feature flags to shed load (non-critical features)
- Throttle heavy endpoints (per IP/user)

## Root cause analysis
- Collect timelines of deploys, alerts, errors, traffic
- Identify failing components, configs, or data patterns

## Closure
- Postmortem with actions (tests, rate limits, circuit breakers, budgets)

